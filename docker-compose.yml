services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: solo_clickhouse
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
    ports:
      - "${CLICKHOUSE_HTTP_PORT}:8123"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - solo_net

  metabase:
    image: metabase/metabase:latest
    container_name: solo_metabase
    depends_on:
      - clickhouse
    ports:
      - "${METABASE_PORT}:3000"
    volumes:
      - metabase_data:/metabase-data
      - ./metabase/plugins:/plugins
    networks:
      - solo_net

  prefect-db:
    platform: linux/amd64
    image: postgres:16-alpine
    container_name: solo_prefect_db
    environment:
      POSTGRES_USER: prefect
      POSTGRES_PASSWORD: prefect
      POSTGRES_DB: prefect
    volumes:
      - prefect_postgres_data:/var/lib/postgresql/data
    networks:
      - solo_net

  prefect-server:
    platform: linux/amd64
    image: prefecthq/prefect:3-python3.12
    container_name: solo_prefect_server
    depends_on:
      - prefect-db
    environment:
      PREFECT_TIMEZONE: ${PREFECT_TIMEZONE}
      PREFECT_UI_API_URL: ${PREFECT_UI_API_URL}
    command: >
      bash -lc "prefect server start --host 0.0.0.0 --port 4200"
    ports:
      - "${PREFECT_UI_PORT:-4200}:4200"
    networks:
      - solo_net


  pipeline:
    build:
      context: .
      dockerfile: runtime/Dockerfile
    container_name: solo_pipeline
    env_file: [ .env ]
    working_dir: /app
    volumes:
      - .:/app
    depends_on:
      - clickhouse
      - prefect-server
    networks: [ solo_net ]
    command: [ "sleep", "infinity" ]

networks:
  solo_net:
    name: solo_net

volumes:
  clickhouse_data:
  metabase_data:
  prefect_postgres_data: